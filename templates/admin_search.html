<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Search - Parking System</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

<!-- Top Navbar with toggle buttons -->
<nav class="navbar bg-light p-2 position-fixed top-0 start-0 z-3" style="width:auto;">
    <button class="btn" style="background-color: transparent;border:none;" data-bs-toggle="offcanvas" data-bs-target="#adminSidebar">
      ☰
    </button>
    <button class="btn position-fixed top-0 end-0 m-3 z-3" style="background-color: transparent;border:none;" data-bs-toggle="offcanvas" data-bs-target="#filterPanel">
        <span class="material-icons">filter_list</span>
    </button>
</nav>

  <!-- Sidebar -->
  <div class="offcanvas offcanvas-start" tabindex="-1" id="adminSidebar">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title fw-bold">Admin Panel</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
      <a href="{{ url_for('dashboard_bp.dashboard') }}">
        <span class="material-icons">home</span> Dashboard
      </a>
      <a href="{{ url_for('dashboard_bp.admin_users') }}">
        <span class="material-icons">group</span> Users
      </a>
      <a href="{{ url_for('dashboard_bp.search_lots') }}">
        <span class="material-icons">search</span> Search
      </a>
      <div class="sidebar-separator"></div>
      <a href="{{ url_for('dashboard_bp.create_charts') }}">
        <span class="material-icons">bar_chart</span> Charts
      </a>
      <button class="btn text-danger text-start w-100" data-bs-toggle="modal" data-bs-target="#logoutModal">
        <span class="material-icons">logout</span> Logout
      </button>
    </div>
  </div>
<!-- Place modal outside the offcanvas -->
{% include 'partials/logout_modal.html' %}

<!-- Filter Sidebar -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="filterPanel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title fw-bold">Filter Lots</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>
    <div class="offcanvas-body">
    <form id="filter-form" class="px-2"> <!-- added padding-x (left+right) -->
        <div class="mb-3">
        <label class="form-label">Location</label>
        <input type="text" class="form-control" name="location">
        </div>
        <div class="mb-3">
        <label class="form-label">Pincode</label>
        <input type="text" class="form-control" name="pincode">
        </div>
        <div class="mb-3">
        <label class="form-label">Availability</label>
        <div class="form-check">
            <input class="form-check-input" type="checkbox" name="availability" value="available">
            <label class="form-check-label">Available</label>
        </div>
        <div class="form-check">
            <input class="form-check-input" type="checkbox" name="availability" value="occupied">
            <label class="form-check-label">Occupied</label>
        </div>
        </div>
        <div class="d-flex justify-content-center">
            <button class="btn btn-primary px-4 py-2" type="submit">Apply Filters</button>
        </div>
    </form>
    </div>
  </div>
</div>

<!-- Main Content -->
<div class="container mt-4">
  <h2>Search Parking Lots and Spots</h2>
  <div id="search-results"></div>
</div>
<!-- Add Lot Modal -->
<div class="modal fade" id="addLotModal" tabindex="-1" aria-labelledby="addLotModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="addLotForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add New Lot</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="text" name="name" placeholder="Lot Name" class="form-control mb-2" required>
        <input type="number" step="0.1" name="price" placeholder="Price (₹ per hour)" class="form-control mb-2" required>
        <input type="text" name="address" placeholder="Address" class="form-control mb-2">
        <input type="text" name="pincode" placeholder="Pincode" class="form-control mb-2">
        <input type="number" name="max_spots" placeholder="Total Spots" class="form-control mb-2" required>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-success">Add Lot</button>
      </div>
    </form>
  </div>
</div>

<!-- Edit Lot Modal -->
<div class="modal fade" id="editLotModal" tabindex="-1" aria-labelledby="editLotModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="editLotForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Parking Lot</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="edit-id">
        <input type="hidden" id="current-max-spots">
        <label>Lot Name</label>
        <input type="text" id="edit-name" class="form-control mb-2" placeholder="Lot Name" required>
        <label>Price per Hour</label>
        <input type="number" id="edit-price" class="form-control mb-2" placeholder="Price (₹ per hour)" required>
        <label>Address</label>
        <input type="text" id="edit-address" class="form-control mb-2" placeholder="Address">
        <label>Pincode</label>
        <input type="text" id="edit-pincode" class="form-control mb-2" placeholder="Pincode">
        <label>Max Spots</label>
        <input type="number" id="edit-max-spots" class="form-control mb-2" placeholder="Max Spots" required>
        <small id="maxSpotError" class="text-danger d-none">New value cannot be less than existing max spots.</small>
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-success">Save Changes</button>
      </div>
    </form>
  </div>
</div>

<!-- Spot Detail Modal -->
<div class="modal fade" id="spotDetailModal" tabindex="-1" aria-labelledby="spotDetailLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="spotDetailForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Spot Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="spot-id">
        <input type="hidden" id="spot-lot-id">
        <div class="mb-2">
          <label>Spot Number</label>
          <input type="text" id="spot-number" class="form-control" readonly>
        </div>
        <div class="mb-2">
          <label>Status</label>
          <select id="spot-status" class="form-control">
            <option value="A">Available</option>
            <option value="O">Occupied</option>
          </select>
        </div>  
      </div>
      <div class="modal-footer d-flex justify-content-between">
        <button type="button" class="btn btn-danger" onclick="deleteSpot()">Delete</button>
        <button type="submit" class="btn btn-success">Update</button>
      </div>
    </form>
  </div>
</div>

<div class="modal fade" id="spotAddModal" tabindex="-1" aria-labelledby="spotDetailLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="addSpotForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Spot Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="add-spot-lot-id">
        <div class="mb-2">
          <label>Status</label>
          <select id="add-spot-status" class="form-control">
            <option value="A">Available</option>
            <option value="O">Occupied</option>
          </select>
        </div>  
      </div>
      <div class="modal-footer d-flex justify-content-between">
        <button type="button" class="btn btn-danger" onclick="deleteSpot()">Delete</button>
        <button type="submit" class="btn btn-success">Add</button>
      </div>
    </form>
  </div>
</div>
<!-- Scripts -->
<script>
function openAddSpotModal(lotId) {
    document.getElementById('add-spot-lot-id').value = lotId;
    document.getElementById('add-spot-status').value = 'A';
    new bootstrap.Modal(document.getElementById('spotAddModal')).show();
}

document.getElementById('filter-form').addEventListener('submit', function (e) {
  e.preventDefault();
  performSearch();
});

async function performSearch() {
  const form = document.getElementById('filter-form');
  const formData = new FormData(form);
  const params = new URLSearchParams();

  const keys = new Set();
  for (const [key, _] of formData.entries()) {
    keys.add(key);
  }

  for (const key of keys) {
    const values = formData.getAll(key);
    values.forEach(val => {
      if (val.trim()) params.append(key, val.trim());
    });
  }

  const url = new URL('/api/search', window.location.origin);
  url.search = params.toString();

  try {
    const res = await fetch(url.toString());
    const data = await res.json();
    renderResults(data);
  } catch (err) {
    console.error('Search failed:', err);
  }
}

function renderResults(lots) {
  const container = document.getElementById('search-results');
  container.innerHTML = '';
  if (!lots.length) {
    container.innerHTML = '<p class="text-danger">No results found.</p>';
    return;
  }

  lots.forEach(lot => {
    const card = document.createElement('div');
    card.setAttribute('data-lot-id', lot.lot_id);
    card.className = 'card p-3 mb-4 shadow-sm';
    card.innerHTML = `
      <div class="d-flex justify-content-between">
        <h5>${lot.prime_location_name}</h5>
        <div class="dropdown">
          <button class="btn btn-light dropdown-toggle" style="background-color: transparent;border:none;" data-bs-toggle="dropdown"></button>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#" style="background-color: transparent;border:none;" onclick='openEditModal(${JSON.stringify(lot)})'>Edit Lot</a></li>
            <li><a class="dropdown-item text-danger" style="background-color: transparent;border:none;" onclick="deleteLot(${lot.lot_id})">Delete Lot</a></li>
          </ul>
        </div>
      </div>
      <p>Pincode: ${lot.pin_code}</p>
      <p>Price: ₹${lot.price} per hour</p>
      <div class="d-flex flex-wrap gap-2" id="spots-${lot.lot_id}"></div>
    `;
    const spotContainer = card.querySelector(`#spots-${lot.lot_id}`);
    lot.spots.forEach(s => {
    const spot = document.createElement('div');
    spot.className = 'spot-card';
    spot.style.backgroundColor = s.status === 'O' ? '#f8d7da' : '#d4edda';
    spot.textContent = s.id;
    spot.onclick = () => showSpotModal(s);
    spotContainer.appendChild(spot);
    });
    const addBtn = document.createElement('div');
    addBtn.className = 'spot-card text-success border-success';
    addBtn.style.borderStyle = 'dashed';
    addBtn.textContent = '+ Add Spot';
    addBtn.onclick = () => openAddSpotModal(lot.lot_id);
    spotContainer.appendChild(addBtn);

    container.appendChild(card);
  });
}

async function loadSpots(lotId) {
  const container = document.getElementById(`spots-${lotId}`);
  const res = await fetch(`/api/spot/status/${lotId}`);
  if (!res.ok) {
    container.innerHTML = '<small class="text-danger">Error loading spots.</small>';
    return;
  }
  const spots = await res.json();
  container.innerHTML = '';
  spots.forEach(s => {
    const spot = document.createElement('div');
    spot.className = 'spot-card';
    spot.style.backgroundColor = s.status === 'O' ? '#f8d7da' : '#d4edda';
    spot.textContent = s.id;
    spot.onclick = () => showSpotModal(s);
    container.appendChild(spot);
  });
  const addBtn = document.createElement('div');
  addBtn.className = 'spot-card text-success border-success';
  addBtn.style.borderStyle = 'dashed';
  addBtn.textContent = '+ Add Spot';
  addBtn.onclick = () => openAddSpotModal(lotId);
  container.appendChild(addBtn);
}

document.getElementById('editLotForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const oldMaxSpots = parseInt(document.getElementById('current-max-spots').value);
    const newMaxSpots = parseInt(document.getElementById('edit-max-spots').value);
    const errorMsg = document.getElementById('maxSpotError');

    if (newMaxSpots < oldMaxSpots) {
        errorMsg.classList.remove('d-none');
        return; // stop submission
    } else {
        errorMsg.classList.add('d-none');
    }

    const data = { 
        id: parseInt(document.getElementById('edit-id').value),
        name: document.getElementById('edit-name').value,
        price: parseFloat(document.getElementById('edit-price').value),
        address: document.getElementById('edit-address').value,
        pincode: document.getElementById('edit-pincode').value,
        max_spots: newMaxSpots
    };

    const res = await fetch('/api/lot/update', {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    });

    if (res.ok) {
        bootstrap.Modal.getInstance(document.getElementById('editLotModal')).hide();
        fetchParkingLots();
    } else {
        alert("Failed to update lot.");
    }
});


document.getElementById('addLotForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const form = e.target;
    const data = {
        name: form.name.value,
        price: parseFloat(form.price.value),
        address: form.address.value,
        pincode: form.pincode.value,
        max_spots: parseInt(form.max_spots.value)
    };

    const res = await fetch('/lot/spot/add', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    });

    if (res.ok) {
        form.reset();
        bootstrap.Modal.getInstance(document.getElementById('addLotModal')).hide();
        renderResults();
    } else {
        const errorData = await res.json();
        alert('Failed to add lot: ' + (errorData.error || 'Unknown error.'));
    }
});

document.getElementById('addSpotForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const lotId = document.getElementById('add-spot-lot-id').value;
    const status = document.getElementById('add-spot-status').value;

    const res = await fetch('/api/spot/add', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ lot_id: lotId, status })
    });

    if (res.ok) {
        bootstrap.Modal.getInstance(document.getElementById('spotAddModal')).hide();
        loadSpots(lotId);
    } else {
        errorData = await res.json();
        alert('Error adding spot: ' + (errorData.error || 'Unknown error'));
    }
});

function openEditModal(lot) {
    console.log('Editing lot:', lot);
    document.getElementById('edit-id').value = lot.id;
    document.getElementById('edit-name').value = lot.prime_location_name;
    document.getElementById('edit-price').value = lot.price;
    document.getElementById('edit-address').value = lot.address || '';
    document.getElementById('edit-pincode').value = lot.pin_code || '';
    document.getElementById('edit-max-spots').value = lot.max_spots;
    document.getElementById("current-max-spots").value = lot.max_spots;
    new bootstrap.Modal(document.getElementById('editLotModal')).show();
}
function deleteLot(id) {
  if (!confirm('Are you sure to delete this lot?')) return;
  fetch(`/api/lot/delete/${id}`, { method: 'DELETE' })
    .then(res => {
      if (res.ok) {
        const card = document.querySelector(`[data-lot-id="${id}"]`);
        if (card) card.remove();
      } else {
        alert('Failed to delete lot.');
      }
    });
}

function showSpotModal(spot) {
    document.getElementById('spot-id').value = spot.id;
    document.getElementById('spot-number').value = spot.number || spot.id;
    document.getElementById('spot-status').value = spot.status || 'available';
    document.getElementById('spot-lot-id').value = spot.lot_id;
    new bootstrap.Modal(document.getElementById('spotDetailModal')).show();
}

document.getElementById('spotDetailForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const spotId = document.getElementById('spot-id').value;
    const lotId = document.getElementById('spot-lot-id').value;
    const status = document.getElementById('spot-status').value;

    let res;
    if (!spotId) {
        res = await fetch('/api/spot/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ lot_id: lotId, status })
        });
        if (res.status === 400) {
            const errorData = await res.json();
            alert('Error: ' + (errorData.error || 'Unknown error'));
            return;
    }
    } else {
        const endpoint = status === 'A' ? 'release' : 'reserve';
        res = await fetch(`/api/spot/${endpoint}/${spotId}`, { method: 'POST' });
    }

    if (res.ok) {
        bootstrap.Modal.getInstance(document.getElementById('spotDetailModal')).hide();
        loadSpots(lotId);
    } else {
        alert('Failed to process spot.');
    }
});

async function deleteSpot() {
    const spotId = document.getElementById('spot-id').value;
    if (!confirm('Are you sure you want to delete this spot?')) return;
    const res = await fetch(`/api/spot/delete/${spotId}`, { method: 'DELETE' });
    if (res.ok) {
        bootstrap.Modal.getInstance(document.getElementById('spotDetailModal')).hide();
        loadSpots(document.getElementById('spot-lot-id').value);
    } else {
        alert('Failed to delete spot.');
    }
}
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
