<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Chart Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

<!-- Sidebar -->
<nav class="navbar bg-light p-2 position-fixed top-0 start-0 z-3 w-100 shadow-sm">
  <button class="btn btn-outline-dark" data-bs-toggle="offcanvas" data-bs-target="#adminSidebar">☰</button>
</nav>
<div class="offcanvas offcanvas-start" tabindex="-1" id="adminSidebar">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title">Admin Panel</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="offcanvas-body">
    <a href="{{ url_for('dashboard_bp.dashboard') }}" class="d-block py-2 text-dark">Dashboard</a>
    <a href="{{ url_for('dashboard_bp.admin_users') }}" class="d-block py-2 text-dark">Users</a>
    <a href="{{ url_for('dashboard_bp.search_lots') }}" class="d-block py-2 text-dark">Search</a>
    <a href="{{ url_for('dashboard_bp.create_charts') }}" class="d-block py-2 text-dark">Charts</a>
    <button class="btn d-block py-2 text-danger w-100 text-start" data-bs-toggle="modal" data-bs-target="#logoutModal">Logout</button>
  </div>
</div>
{% include 'partials/logout_modal.html' %}

<!-- Chart Area -->
<div class="chart-wrapper">
  <div class="switcher">
    <button class="active" onclick="switchChart(0)">Overall Status</button>
    <button onclick="switchChart(1)">Monthly Revenue</button>
    <button onclick="switchChart(2)">Lot-wise Status</button>
    <button onclick="switchChart(3)">Lot-wise Activity</button>
    <button onclick="switchChart(4)">Top Lots</button>
  </div>

  <div id="lotDropdown" class="mb-4 text-center" style="display: none;">
    <label for="lotSelect"><strong>Select Parking Lot:</strong></label>
    <select id="lotSelect" class="form-select w-auto d-inline-block"></select>
  </div>

  <div class="chart-section active"><canvas id="overallStatusChart"></canvas></div>
  <div class="chart-section"><canvas id="monthlyRevenueChart"></canvas></div>
  <div class="chart-section"><canvas id="lotStatusChart"></canvas></div>
  <div class="chart-section"><canvas id="lotDailyChart"></canvas></div>
  <div class="chart-section"><canvas id="topLotsChart"></canvas></div>
</div>

<script>
  let lotStatusChart = null;
  let lotDailyChart = null;

  function switchChart(index) {
    const buttons = document.querySelectorAll('.switcher button');
    const sections = document.querySelectorAll('.chart-section');
    const lotDropdown = document.getElementById('lotDropdown');
    buttons.forEach(btn => btn.classList.remove('active'));
    sections.forEach(s => s.classList.remove('active'));
    buttons[index].classList.add('active');
    sections[index].classList.add('active');
    lotDropdown.style.display = (index === 2 || index === 3) ? 'block' : 'none';
  }

  // Dropdown + default lot charts
  fetch('/api/chart/admin/lot-names')
    .then(res => res.json())
    .then(lots => {
      const select = document.getElementById('lotSelect');
      lots.forEach(lot => {
        const opt = document.createElement('option');
        opt.value = lot;
        opt.textContent = lot;
        select.appendChild(opt);
      });
      if (lots.length) updateLotCharts(lots[0]);
    });

  document.getElementById('lotSelect').addEventListener('change', e => {
    updateLotCharts(e.target.value);
  });

  function updateLotCharts(lot) {
    fetch(`/api/chart/admin/lot-status?lot=${encodeURIComponent(lot)}`)
      .then(res => res.json())
      .then(data => {
        if (lotStatusChart) lotStatusChart.destroy();
        lotStatusChart = new Chart(document.getElementById('lotStatusChart'), {
          type: 'pie',
          data: {
            labels: ['Available', 'Occupied'],
            datasets: [{ data: data.map(d => d.count), backgroundColor: ['#34d399', '#f87171'] }]
          },
          options: {
            plugins: { title: { display: true, text: `Status in ${lot}` } },
            responsive: true
          }
        });
      });

    fetch(`/api/chart/admin/lot-daily-activity?lot=${encodeURIComponent(lot)}`)
      .then(res => res.json())
      .then(data => {
        if (lotDailyChart) lotDailyChart.destroy();
        lotDailyChart = new Chart(document.getElementById('lotDailyChart'), {
          type: 'line',
          data: {
            labels: data.map(d => d.date),
            datasets: [{
              label: 'Reservations',
              data: data.map(d => d.count),
              borderColor: '#60a5fa',
              fill: false,
              tension: 0.3
            }]
          },
          options: {
            plugins: { title: { display: true, text: `Last 30 Days Activity in ${lot}` } },
            responsive: true
          }
        });
      });
  }

  // Static Charts
  fetch('/api/chart/admin/spot-status')
    .then(res => res.json())
    .then(data => {
      new Chart(document.getElementById('overallStatusChart'), {
        type: 'pie',
        data: {
          labels: ['Available', 'Occupied'],
          datasets: [{ data: data.map(d => d.count), backgroundColor: ['#34d399', '#f87171'] }]
        },
        options: {
          plugins: { title: { display: true, text: 'Overall Spot Status' } },
          responsive: true
        }
      });
    });

  fetch('/api/chart/admin/monthly-revenue')
    .then(res => res.json())
    .then(data => {
      const values = data.map(d => d.revenue);
      const maxVal = Math.max(...values, 0);

      new Chart(document.getElementById('monthlyRevenueChart'), {
        type: 'bar',
        data: {
          labels: data.map(d => d.month),
          datasets: [{
            label: 'Revenue (₹)',
            data: values,
            backgroundColor: '#fbbf24'
          }]
        },
        options: {
          maintainAspectRatio: false,
          plugins: { title: { display: true, text: 'Monthly Revenue' } },
          responsive: true,
          elements: {
            bar: { borderRadius: 4, barThickness: 30, maxBarThickness: 40 }
          },
          scales: {
            y: {
              beginAtZero: true,
              max: Math.ceil(maxVal * 1.2)
            }
          }
        }
      });
    });

  fetch('/api/chart/admin/top-lots')
    .then(res => res.json())
    .then(data => {
      const values = data.map(d => d.count);
      const maxVal = Math.max(...values, 0);

      new Chart(document.getElementById('topLotsChart'), {
        type: 'bar',
        data: {
          labels: data.map(d => d.lot),
          datasets: [{
            label: 'Reservations',
            data: values,
            backgroundColor: '#c084fc'
          }]
        },
        options: {
          maintainAspectRatio: false,
          plugins: { title: { display: true, text: 'Top Lots by Reservations' } },
          responsive: true,
          elements: {
            bar: { borderRadius: 4, barThickness: 30, maxBarThickness: 40 }
          },
          scales: {
            y: {
              beginAtZero: true,
              max: Math.ceil(maxVal * 1.2)
            }
          }
        }
      });
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
