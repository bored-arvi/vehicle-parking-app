<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>User Dashboard - Parking</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .spot-card {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 8px;
      min-width: 80px;
      text-align: center;
      cursor: pointer;
    }
  </style>
</head>
<body class="bg-light">

<!-- Hidden user info -->
<div id="user-info" data-user="{{ session['user_id'] }}"></div>

<!-- Navbar -->
<nav class="navbar bg-light p-2 position-fixed top-0 start-0 z-3" style="width:auto;">
  <button class="btn btn-outline-dark" data-bs-toggle="offcanvas" data-bs-target="#adminSidebar">
    ☰ 
  </button>
</nav>
<div class="offcanvas offcanvas-start" tabindex="-1" id="adminSidebar">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title">User Panel</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="offcanvas-body">
    <a href="/dashboard/user" class="d-block py-2 text-dark">Dashboard</a>
    <a href="/dashboard/user/reservations" class="d-block py-2 text-dark">My Reservations</a>
    <a href="/dashboard/user/charts" class="d-block py-2 text-dark">Summary</a>
    <a href="/logout/user" class="d-block py-2 text-dark">Logout</a>
  </div>
</div>

<!-- Content -->
<div class="container my-4">
  <h2 class="mb-4">Available Parking Lots</h2>
  <div id="lots-container"></div>
</div>

<!-- Reserve Modal -->
<div class="modal fade" id="reserveModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="reserve-form">
        <div class="modal-header">
          <h5 class="modal-title">Confirm Reservation</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="reserve-spot-id">
          <div class="mb-3">
            <label for="vehicle-number" class="form-label">Vehicle Number</label>
            <input type="text" class="form-control" id="vehicle-number" required>
          </div>
          <p>Are you sure you want to reserve this spot?</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success">Reserve</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
const userId = document.getElementById("user-info").dataset.user;

document.getElementById('reserve-form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const spotId = document.getElementById('reserve-spot-id').value;
  const vehicleNumber = document.getElementById('vehicle-number').value;

  const res = await fetch('/api/reservations/add', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ user_id: userId, spot_id: spotId, vehicle_number: vehicleNumber })
  });

  const res1 = await fetch(`/api/spot/reserve/${spotId}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' }
  });

  if (res.ok && res1.ok) {
    bootstrap.Modal.getInstance(document.getElementById('reserveModal')).hide();
    await fetchLots();
  } else {
    alert('Reservation failed');
  }
});

async function fetchLots() {
  const res = await fetch('/api/lots');
  const lots = await res.json();
  const container = document.getElementById('lots-container');
  container.innerHTML = '';
  lots.forEach(lot => {
    const card = document.createElement('div');
    card.className = 'card p-3 mb-4 shadow-sm';
    card.innerHTML = `
      <h5>${lot.prime_location_name}</h5>
      <p>Price: ₹${lot.price}</p>
      <p>Pincode: ${lot.pin_code}</p>
      <div class="d-flex flex-wrap gap-2" id="spots-${lot.id}">Loading spots...</div>
    `;
    container.appendChild(card);
    renderSpots(lot.id);
  });
}

async function renderSpots(lotId) {
  const container = document.getElementById(`spots-${lotId}`);
  const res = await fetch(`/api/spot/status/${lotId}`);
  const spots = await res.json();
  container.innerHTML = '';
  spots.forEach(s => {
    const div = document.createElement('div');
    div.className = 'spot-card';
    div.style.backgroundColor = s.status === 'O' ? '#f8d7da' : '#d4edda';
    div.textContent = s.id;
    if (s.status === 'A') {
      div.onclick = () => promptReservation(s.id);
    } else {
      div.onclick = () => alert('Spot is occupied.');
    }
    container.appendChild(div);
  });
}

function promptReservation(spotId) {
  document.getElementById('reserve-spot-id').value = spotId;
  new bootstrap.Modal(document.getElementById('reserveModal')).show();
}

window.onload = () => {
  fetchLots();
};
</script>
</body>
</html>
