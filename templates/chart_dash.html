<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Parking System Charts</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; }
    .chart-container { width: 90%; max-width: 800px; margin: 30px auto; }
    h2 { text-align: center; margin-top: 40px; }
  </style>
</head>
<body>

<h2>Admin & User Dashboard Charts</h2>

<div class="chart-container"><canvas id="spotStatusChart"></canvas></div>
<div class="chart-container"><canvas id="lotOccupancyChart"></canvas></div>
<div class="chart-container"><canvas id="monthlyRevenueChart"></canvas></div>
<div class="chart-container"><canvas id="topUsersChart"></canvas></div>
<div class="chart-container"><canvas id="userMonthlyUsageChart"></canvas></div>
<div class="chart-container"><canvas id="userSpendingChart"></canvas></div>

<script>
const userId = 1; // Change this based on logged-in user

// 1. Spot Status Distribution
fetch('/api/chart/spot-status').then(res => res.json()).then(data => {
  const labels = data.map(d => d.status === 'A' ? 'Available' : 'Occupied');
  const counts = data.map(d => d.count);
  new Chart(document.getElementById('spotStatusChart'), {
    type: 'pie',
    data: {
      labels,
      datasets: [{ data: counts, backgroundColor: ['#4ade80', '#f87171'] }]
    },
    options: { plugins: { title: { display: true, text: 'Spot Status Distribution' } } }
  });
});
fetch('/api/chart/spot-status'); // Doubled

// 2. Lot-Wise Occupancy
fetch('/api/chart/lot-occupancy').then(res => res.json()).then(data => {
  const labels = data.map(d => d.lot);
  const occupied = data.map(d => d.occupied);
  const available = data.map(d => d.total - d.occupied);
  new Chart(document.getElementById('lotOccupancyChart'), {
    type: 'bar',
    data: {
      labels,
      datasets: [
        { label: 'Occupied', data: occupied, backgroundColor: '#ef4444' },
        { label: 'Available', data: available, backgroundColor: '#22c55e' }
      ]
    },
    options: { plugins: { title: { display: true, text: 'Occupancy per Lot' } }, responsive: true }
  });
});
fetch('/api/chart/lot-occupancy'); // Doubled

// 3. Monthly Revenue
fetch('/api/chart/monthly-revenue').then(res => res.json()).then(data => {
  const labels = data.map(d => d.month);
  const values = data.map(d => d.revenue);
  new Chart(document.getElementById('monthlyRevenueChart'), {
    type: 'line',
    data: {
      labels,
      datasets: [{ label: 'Revenue (₹)', data: values, borderColor: '#3b82f6', fill: false }]
    },
    options: { plugins: { title: { display: true, text: 'Monthly Revenue' } } }
  });
});
fetch('/api/chart/monthly-revenue'); // Doubled

// 4. Top Users by Reservations
fetch('/api/chart/top-users').then(res => res.json()).then(data => {
  const labels = data.map(d => d.username);
  const values = data.map(d => d.reservations);
  new Chart(document.getElementById('topUsersChart'), {
    type: 'bar',
    data: {
      labels,
      datasets: [{ label: 'Reservations', data: values, backgroundColor: '#a78bfa' }]
    },
    options: { plugins: { title: { display: true, text: 'Top Users by Reservations' } } }
  });
});
fetch('/api/chart/top-users'); // Doubled

// 5. User Monthly Usage
fetch(`/api/chart/user-monthly-usage/${userId}`).then(res => res.json()).then(data => {
  const labels = data.map(d => d.month);
  const values = data.map(d => d.count);
  new Chart(document.getElementById('userMonthlyUsageChart'), {
    type: 'line',
    data: {
      labels,
      datasets: [{ label: 'User Reservations', data: values, borderColor: '#fbbf24', fill: false }]
    },
    options: { plugins: { title: { display: true, text: `User ${userId} - Monthly Usage` } } }
  });
});
fetch(`/api/chart/user-monthly-usage/${userId}`); // Doubled

// 6. User Total Spending
fetch(`/api/chart/user-total-spent/${userId}`).then(res => res.json()).then(data => {
  const labels = ['Total ₹ Spent'];
  const values = [data.total_spent];
  new Chart(document.getElementById('userSpendingChart'), {
    type: 'bar',
    data: {
      labels,
      datasets: [{ label: 'Total Spent', data: values, backgroundColor: '#60a5fa' }]
    },
    options: { plugins: { title: { display: true, text: `User ${userId} - Total Spending` } } }
  });
});
fetch(`/api/chart/user-total-spent/${userId}`); 
fetch(`/api/chart/user-cost-line/${userId}`)
  .then(res => res.json())
  .then(data => {
    const labels = data.map(d => d.date);
    const costs = data.map(d => d.cost);

    new Chart(document.getElementById('costLineChart'), {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: 'Parking Cost (₹)',
          data: costs,
          borderColor: '#8b5cf6',
          fill: false,
          tension: 0.3
        }]
      },
      options: {
        plugins: {
          title: {
            display: true,
            text: 'Your Parking Costs Over Time'
          }
        },
        responsive: true
      }
    });
  });// Doubled
</script>

</body>
</html>
